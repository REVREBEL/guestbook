// scripts/build-master-doc.mjs

import { promises as fs } from "fs";
import path from "path";

const ROOT = process.cwd();
const DOCS_DIR = path.join(ROOT, "docs");
const ARCHIVE_DIR = path.join(DOCS_DIR, "archive");
const OUTPUT_FILE = "MASTER_GUIDE.md";
const OUTPUT_PATH = path.join(DOCS_DIR, OUTPUT_FILE);

// Order the important ones explicitly; everything else will be appended.
const ORDERED_FILES = [
  "README.md",
];

function toNiceTitle(filename) {
  const base = filename.replace(/\.md$/i, "");
  return base
    .replace(/_/g, " ")
    .replace(/-/g, " ")
    .replace(/\s+/g, " ")
    .replace(/\b\w/g, (c) => c.toUpperCase());
}

function normalizeContent(content) {
  let out = content.trim();
  const lines = out.split(/\r?\n/);

  if (lines[0]?.startsWith("# ")) {
    lines.shift();
    out = lines.join("\n").trim();
  }

  return out;
}

function timestamp() {
  const d = new Date();
  const pad = (n) => String(n).padStart(2, "0");
  return (
    d.getFullYear() +
    pad(d.getMonth() + 1) +
    pad(d.getDate()) +
    "-" +
    pad(d.getHours()) +
    pad(d.getMinutes()) +
    pad(d.getSeconds())
  );
}

async function ensureDirs() {
  await fs.mkdir(DOCS_DIR, { recursive: true });
  await fs.mkdir(ARCHIVE_DIR, { recursive: true });
}

async function archiveExistingMaster() {
  try {
    await fs.access(OUTPUT_PATH);
    const archivedName = `MASTER_GUIDE-${timestamp()}.md`;
    const archivedPath = path.join(ARCHIVE_DIR, archivedName);
    await fs.rename(OUTPUT_PATH, archivedPath);
    console.log(`üì¶ Archived previous MASTER_GUIDE.md ‚Üí docs/archive/${archivedName}`);
  } catch {
    // No existing master doc ‚Äî nothing to archive
  }
}

async function main() {
  await ensureDirs();
  await archiveExistingMaster();

  const dirEntries = await fs.readdir(ROOT, { withFileTypes: true });
  const allMd = dirEntries
    .filter((d) => d.isFile() && d.name.toLowerCase().endsWith(".md"))
    .map((d) => d.name)
    .filter((name) => name !== OUTPUT_FILE);

  const ordered = [
    ...ORDERED_FILES.filter((f) => allMd.includes(f)),
    ...allMd.filter((f) => !ORDERED_FILES.includes(f)),
  ];

  let combined = "# Memorial Site v2 ‚Äì Master Guide\n\n";
  combined +=
    "> This document is auto-generated by `scripts/build-master-doc.mjs` by combining Markdown files in the repo.\n\n";

  for (const filename of ordered) {
    const filePath = path.join(ROOT, filename);
    const raw = await fs.readFile(filePath, "utf8");
    const body = normalizeContent(raw);
    const title = toNiceTitle(filename);

    combined += `\n---\n\n`;
    combined += `## ${title}\n\n`;
    combined += `<!-- Source: ${filename} -->\n\n`;
    combined += body + "\n";
  }

  await fs.writeFile(OUTPUT_PATH, combined, "utf8");
  console.log(`‚úÖ Wrote docs/MASTER_GUIDE.md with ${ordered.length} sections.`);
}

main().catch((err) => {
  console.error("‚ùå Error building master doc:", err);
  process.exit(1);
});